function saveSelection(){return rangy.saveRestore.saveSelection()}function restoreSelection(a){a&&rangy.saveRestore.restoreSelection(a)}var rangy=function(){function h(c,d){var e=typeof c[d];return e==b||e==a&&!!c[d]||e=="unknown"}function i(b,c){return typeof b[c]==a&&!!b[c]}function j(a,b){return typeof a[b]!=c}function k(a){return function(b,c){var d=c.length;while(d--)if(!a(b,c[d]))return!1;return!0}}function p(a){alert("Rangy not supported in your browser. Reason: "+a),o.initialized=!0,o.supported=!1}function q(){var a,b=!1,c=!1;h(document,"createRange")&&(a=document.createRange(),l(a,e)&&n(a,d)&&(b=!0),a.detach()),i(document,"body")&&h(document.body,"createTextRange")&&(a=document.body.createTextRange(),l(a,g)&&n(a,f)&&(c=!0)),!b&&!c&&p("Neither Range nor TextRange are implemented"),o.initialized=!0,o.features={implementsDomRange:b,implementsTextRange:c};for(var j=0,k=r.length;j<k;++j)try{r[j](o)}catch(m){}}function s(a){this.name=a,this.initialized=!1,this.supported=!1}var a="object",b="function",c="undefined",d=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer","START_TO_START","START_TO_END","END_TO_START","END_TO_END"],e=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],f=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],g=["collapse","compareEndPoints","duplicate","getBookmark","moveToBookmark","moveToElementText","parentElement","pasteHTML","select","setEndPoint"],l=k(h),m=k(i),n=k(j),o={initialized:!1,supported:!1,util:{isHostMethod:h,isHostObject:i,isHostProperty:j,areHostMethods:l,areHostObjects:m,areHostProperties:n},features:{},modules:{}};o.fail=p,o.init=q;var r=[];o.addInitListener=function(a){r.push(a)},s.prototype.fail=function(a){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+a)},o.createModule=function(a,b){var c=new s(a);o.modules[a]=c,r.push(function(a){b(a,c),c.initialized=!0,c.supported=!0})},o.requireModules=function(a){for(var b=0,c=a.length,d,e;b<c;++b){e=a[b],d=o.modules[e];if(!d||!(d instanceof s))throw new Error("Module '"+e+"' not found");if(!d.supported)throw new Error("Module '"+e+"' not supported")}};var t=!1,u,v=function(a){t||(t=!0,o.initialized||q())};if(typeof window==c){p("No window found");return}if(typeof document==c){p("No document found");return}return h(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",v,!1),h(window,"addEventListener")?window.addEventListener("load",v,!1):h(window,"attachEvent")?window.attachEvent("onload",v):(u=window.onload,window.onload=function(a){v(a),u&&u.call(window,a)}),o}();rangy.createModule("DomUtil",function(a,b){function f(a){var b=0;while(a=a.previousSibling)b++;return b}function g(a,b){var c=[],d;for(d=a;d;d=d.parentNode)c.push(d);for(d=b;d;d=d.parentNode)if(e(c,d))return d;return null}function h(a,b,c){var d=c?b:b.parentNode;while(d){if(d===a)return!0;d=d.parentNode}return!1}function i(a,b,c){var d,e=c?a:a.parentNode;while(e){d=e.parentNode;if(d===b)return e;e=d}return null}function j(a){var b=a.nodeType;return b==3||b==4||b==8}function k(a,b){var c=b.nextSibling,d=b.parentNode;return c?d.insertBefore(a,c):d.appendChild(a),a}function l(a,b){var c;return a.nodeType==3?c=a.splitText(b):(c=a.cloneNode(),c.deleteData(0,b),a.deleteData(0,a.length-b),k(c,a)),c}function m(a){if(a.nodeType==9)return a;if(typeof a.ownerDocument!="undefined")return a.ownerDocument;if(typeof a.document!="undefined")return a.document;if(a.parentNode)return m(a.parentNode);throw new Error("getDocument: no document found for node")}function n(a,b,c,d){var e,h,j,k,l;if(a==c)return b===d?0:b<d?-1:1;if(e=i(c,a,!0))return b<=f(e)?-1:1;if(e=i(a,c,!0))return f(e)<d?-1:1;h=g(a,c),j=a===h?h:i(a,h,!0),k=c===h?h:i(c,h,!0);if(j===k)throw new Error("comparePoints got to case 4 and childA and childB are the same!");l=h.firstChild;while(l){if(l===j)return-1;if(l===k)return 1;l=l.nextSibling}throw new Error("Should not be here!")}function o(a){this.root=a,this._next=a}function p(a){return new o(a)}function q(a,b){this.node=a,this.offset=b}function s(a){this.code=r[a],this.codeName=a,this.message="DOMException: "+this.codeName}a.util.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||b.fail("document missing a Node creation method");var c=document.createElement("div");a.util.areHostMethods(c,["insertBefore","appendChild","cloneNode"]||!a.util.areHostObjects(c,["previousSibling","nextSibling","childNodes","parentNode"]))||b.fail("Incomplete Element implementation");var d=document.createTextNode("test");a.util.areHostMethods(d,["splitText","deleteData","insertData","appendData","cloneNode"]||!a.util.areHostObjects(c,["previousSibling","nextSibling","childNodes","parentNode"])||!a.util.areHostProperties(d,["data"]))||b.fail("Incomplete Text Node implementation");var e=function(a,b){var c=a.length;while(c--)if(a[c]===b)return!0;return!1};o.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next,b,c;if(this._current){b=a.firstChild;if(b)this._next=b;else{c=null;while(a!==this.root&&!(c=a.nextSibling))a=a.parentNode;this._next=c}}return this._current},detach:function(){this._current=this._next=this.root=null}},q.prototype={equals:function(a){return this.node===a.node&this.offset==a.offset}};var r={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11};s.prototype=r,s.prototype.toString=function(){return this.message},a.dom={arrayContains:e,getNodeIndex:f,getCommonAncestor:g,isAncestorOf:h,getClosestAncestorIn:i,isCharacterDataNode:j,insertAfter:k,splitDataNode:l,getDocument:m,comparePoints:n,createIterator:p,DomPosition:q,DOMException:s}}),rangy.createModule("DomRange",function(a,b){function f(a){return a?c.isCharacterDataNode(a)?'"'+a.data+'"':a.nodeName:"No node"}function g(a){return c.getDocument(a.startContainer)}function h(a,b,c){var d=a._listeners[b];if(d)for(var e=0,f=d.length;e<f;++e)d[e].call(a,{target:a,args:c})}function i(a){a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset,a.commonAncestorContainer=a.collapsed?a.startContainer:c.getCommonAncestor(a.startContainer,a.endContainer)}function j(a,b,c,d,e){var f=a.startContainer!==b||a.startOffset!==c,g=a.endContainer!==d||a.endOffset!==e;a.startContainer=b,a.startOffset=c,a.endContainer=d,a.endOffset=e,i(a),h(a,"boundarychange",{startMoved:f,endMoved:g})}function k(a){return new d(a.parentNode,c.getNodeIndex(a))}function l(a){return new d(a.parentNode,c.getNodeIndex(a)+1)}function m(a){return c.isCharacterDataNode(a)?a.length:a.childNodes?a.childNodes.length:0}function n(a,b,d){return c.isCharacterDataNode(b)?d==b.length?b.parentNode.appendChild(a):b.parentNode.insertBefore(a,d==0?b:c.splitDataNode(b,d)):d>=b.childNodes.length?b.appendChild(a):b.insertBefore(a,b.childNodes[d]),a}function o(a){var b;for(var c,d=g(a.range).createDocumentFragment(),f;c=a.next();){b=a.isPartiallySelectedSubtree(),c=c.cloneNode(!b),b&&(f=a.getSubtreeIterator(),c.appendChild(o(f)),f.detach(!0));if(c.nodeType==10)throw new e("HIERARCHY_REQUEST_ERR");d.appendChild(c)}return d}function p(a,b,d){var e,f;d=d||{stop:!1};for(var g,h;g=a.next();)if(a.isPartiallySelectedSubtree()){if(b(g)===!1){d.stop=!0;return}h=a.getSubtreeIterator(),p(h,b,d),h.detach(!0);if(d.stop)return}else{e=c.createIterator(g);while(f=e.next())if(b(f)===!1){d.stop=!0;return}}}function q(a){var b;while(a.next())a.isPartiallySelectedSubtree()?(b=a.getSubtreeIterator(),q(b),b.detach(!0)):a.remove()}function r(a){for(var b,c=g(a.range).createDocumentFragment(),d;b=a.next();){a.isPartiallySelectedSubtree()?(b=b.cloneNode(!1),d=a.getSubtreeIterator(),b.appendChild(r(d)),d.detach(!0)):a.remove();if(b.nodeType==10)throw new e("HIERARCHY_REQUEST_ERR");c.appendChild(b)}return c}function s(a){return function(){K(this);var b=this.startContainer,d=this.startOffset,e=this.commonAncestorContainer,f=new _(this,!0),g,h;b!==e&&(g=c.getClosestAncestorIn(b,e,!0),h=l(g),b=h.node,d=h.offset),p(f,O),f.reset();var i=a(f);return f.detach(),j(this,b,d,b,d),i}}function t(a,b,c){var d=!!b&&!!b.length,e,f=!!c;d&&(e=new RegExp("^("+b.join("|")+")$"));var g=[];return p(new _(a,!1),function(a){(!d||e.test(a.nodeType))&&(!f||c(a))&&g.push(a)}),g}function u(a,b,c){this.nodes=t(a,b,c),this._next=this.nodes[0],this._pointer=0}function v(a,b){return function(c){K(this),L(c,z),L(F(c),A);var d=(a?k:l)(c);(b?x:y)(this,d.node,d.offset)}}function w(a,b){return a.nodeType!=3&&(c.isAncestorOf(a,b.startContainer,!0)||c.isAncestorOf(a,b.endContainer,!0))}function x(a,b,d){var e=a.endContainer,f=a.endOffset;if(b!==a.startContainer||d!==this.startOffset){if(F(b)!=F(e)||c.comparePoints(b,d,e,f)==1)e=b,f=d;j(a,b,d,e,f)}}function y(a,b,d){var e=a.startContainer,f=a.startOffset;if(b!==a.endContainer||d!==this.endOffset){if(F(b)!=F(e)||c.comparePoints(b,d,e,f)==-1)e=b,f=d;j(a,e,f,b,d)}}function E(a){return function(b,d){var e,f=d?b:b.parentNode;while(f){e=f.nodeType;if(c.arrayContains(a,e))return f;f=f.parentNode}return null}}function F(a){var b;while(b=a.parentNode)a=b;return a}function J(a,b){if(I(a,b))throw new R("INVALID_NODE_TYPE_ERR")}function K(a){if(!a.startContainer)throw new e("INVALID_STATE_ERR")}function L(a,b){if(!c.arrayContains(b,a.nodeType))throw new R("INVALID_NODE_TYPE_ERR")}function M(a,b){if(b<0||b>(c.isCharacterDataNode(a)?a.length:a.childNodes.length))throw new e("INDEX_SIZE_ERR")}function N(a,b){if(G(a,!0)!==G(b,!0))throw new e("WRONG_DOCUMENT_ERR")}function O(a){if(H(a,!0))throw new e("NO_MODIFICATION_ALLOWED_ERR")}function P(a,b){if(!a)throw new e(b)}function R(a){this.code=Q[a],this.codeName=a,this.message="RangeException: "+this.codeName}function S(a){this.startContainer=a,this.startOffset=0,this.endContainer=a,this.endOffset=0,this._listeners={boundarychange:[],detach:[]},i(this)}function _(a,b){this.range=a,this.clonePartiallySelectedTextNodes=b;if(!a.collapsed){this.sc=a.startContainer,this.so=a.startOffset,this.ec=a.endContainer,this.eo=a.endOffset;var d=a.commonAncestorContainer;this.sc===this.ec&&c.isCharacterDataNode(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc===d&&!c.isCharacterDataNode(this.sc)?this.sc.childNodes[this.so]:c.getClosestAncestorIn(this.sc,d,!0),this._last=this.ec===d&&!c.isCharacterDataNode(this.ec)?this.ec.childNodes[this.eo-1]:c.getClosestAncestorIn(this.ec,d,!0))}}a.requireModules(["DomUtil"]);var c=a.dom,d=c.DomPosition,e=c.DOMException;u.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){return this._current=this._next,this._next=this.nodes[this._pointer++],this._current},detach:function(){this._current=this._next=this.nodes=null}};var z=[1,3,4,5,7,8,10],A=[2,9,11],B=[5,6,10,12],C=[1,3,4,5,7,8,10,11],D=[1,3,4,5,7,8],G=E([9,11]),H=E(B),I=E([6,10,12]),Q={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2};R.prototype=Q,R.prototype.toString=function(){return this.message};var T=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],U=0,V=1,W=3,X=0,Y=1,Z=2,$=3;S.copyComparisonConstants=function(a){var b=["START_TO_START","START_TO_END","END_TO_END","END_TO_START"],c=b.length;while(c--)a[b[c]]=c},S.copyComparisonConstants(S),S.NODE_BEFORE=X,S.NODE_AFTER=Y,S.NODE_BEFORE_AND_AFTER=Z,S.NODE_INSIDE=$,S.prototype={NODE_BEFORE:X,NODE_AFTER:Y,NODE_BEFORE_AND_AFTER:Z,NODE_INSIDE:$,attachListener:function(a,b){this._listeners[a].push(b)},setStart:function(a,b){K(this),J(a,!0),M(a,b),x(this,a,b)},setEnd:function(a,b){K(this),J(a,!0),M(a,b),y(this,a,b)},setStartBefore:v(!0,!0),setStartAfter:v(!1,!0),setEndBefore:v(!0,!1),setEndAfter:v(!1,!1),collapse:function(a){K(this),a?j(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):j(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(a){K(this),J(a,!0),j(this,a,0,a,m(a))},selectNode:function(a){K(this),J(a,!1),L(a,z);var b=k(a),c=l(a);j(this,b.node,b.offset,c.node,c.offset)},compareBoundaryPoints:function(a,b){K(this),N(this.startContainer,b.startContainer);var d,e,f,g,h=a==W||a==U?"start":"end",i=a==V||a==U?"start":"end";return d=this[h+"Container"],e=this[h+"Offset"],f=b[i+"Container"],g=b[i+"Offset"],c.comparePoints(d,e,f,g)},insertNode:function(a){K(this),L(a,C),O(this.startContainer);if(c.isAncestorOf(a,this.startContainer,!0))throw new e("HIERARCHY_REQUEST_ERR");n(a,this.startContainer,this.startOffset),this.setStartBefore(a)},cloneContents:function(){K(this);var a,b;if(this.collapsed)return g(this).createDocumentFragment();if(this.startContainer===this.endContainer&&c.isCharacterDataNode(this.startContainer))return a=this.startContainer.cloneNode(!0),a.data=a.data.slice(this.startOffset,this.endOffset),b=g(this).createDocumentFragment(),b.appendChild(a),b;var d=new _(this,!0);return a=o(d),d.detach(),a},extractContents:s(r),deleteContents:s(q),surroundContents:function(a){K(this),O(this.startContainer),O(this.endContainer),L(a,D);var b=new _(this,!0),c=b._first&&w(b._first,this)||b._last&&w(b._last,this);b.detach();if(c)throw new R("BAD_BOUNDARYPOINTS_ERR");var d=this.extractContents();if(a.hasChildNodes())while(a.lastChild)a.removeChild(a.lastChild);n(a,this.startContainer,this.startOffset),a.appendChild(d),this.selectNode(a)},cloneRange:function(){K(this);var a=new S(g(this)),b=T.length,c;while(b--)c=T[b],a[c]=this[c];return a},detach:function(){K(this),this.startContainer=this.startOffset=this.endContainer=this.endOffset=null,this.collapsed=this.commonAncestorContainer=null,h(this,"detach",null),this._listeners=null},toString:function(){K(this);var a=this.startContainer;if(a===this.endContainer&&c.isCharacterDataNode(a))return a.nodeType==3||a.nodeType==4?a.data.slice(this.startOffset,this.endOffset):"";var b=[],d=new _(this,!0);return p(d,function(a){a.nodeType!=2,(a.nodeType==3||a.nodeType==4)&&b.push(a.data)}),d.detach(),b.join("")},compareNode:function(a){K(this);var b=a.parentNode,d=c.getNodeIndex(a);if(!b)throw new e("NOT_FOUND_ERR");var f=this.comparePoint(b,d),g=this.comparePoint(b,d+1);return f<0?g>0?Z:X:g>0?Y:$},comparePoint:function(a,b){return K(this),P(a,"HIERARCHY_REQUEST_ERR"),N(a,this.startContainer),c.comparePoints(a,b,this.startContainer,this.startOffset)<0?-1:c.comparePoints(a,b,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:function(a){K(this);var b=this.startContainer,d=b.nodeType==1?b:b.parentNode;P(d,"NOT_SUPPORTED_ERR");var e=d.cloneNode(!1);e.innerHTML=a;var f=c.getDocument(d).createDocumentFragment(),g;while(g=d.firstChild)f.appendChild(g);return f},intersectsNode:function(a){K(this),P(a,"NOT_FOUND_ERR");if(c.getDocument(a)!==g(this))return!1;var b=a.parentNode,d=c.getNodeIndex(a);P(a,"NOT_FOUND_ERR");var e=c.comparePoints(b,d,this.startContainer,this.startOffset),f=c.comparePoints(b,d+1,this.endContainer,this.endOffset);return!(e<0&&f<0||e>0&&f>0)},isPointInRange:function(a,b){return K(this),P(a,"HIERARCHY_REQUEST_ERR"),N(a,this.startContainer),c.comparePoints(a,b,this.startContainer,this.startOffset)>=0&&c.comparePoints(a,b,this.endContainer,this.endOffset)<=0},intersectsRange:function(a){K(this);if(g(a)!=g(this))throw new e("WRONG_DOCUMENT_ERR");return c.comparePoints(this.startContainer,this.startOffset,a.endContainer,a.endOffset)<0&&c.comparePoints(this.endContainer,this.endOffset,a.startContainer,a.startOffset)>0},splitBoundaries:function(){var a=this.startContainer,b=this.startOffset,d=this.endContainer,e=this.endOffset,f=a===d;K(this),c.isCharacterDataNode(d)&&e<d.length&&(c.splitDataNode(d,e),this.setEnd(d,e)),c.isCharacterDataNode(a)&&b>0&&(a=c.splitDataNode(a,b),f&&this.setEnd(a,e-b),b=0,this.setStart(a,b))},normalizeBoundaries:function(){var a=this.startContainer,b=this.startOffset,d=this.endContainer,e=this.endOffset,f,g=a===d;K(this),c.isCharacterDataNode(d)&&(f=d.nextSibling,f&&c.isCharacterDataNode(f)&&(d.appendData(f.data),f.parentNode.removeChild(f),this.setEnd(d,e))),c.isCharacterDataNode(a)&&(f=a.previousSibling,f&&c.isCharacterDataNode(f)&&(a.insertData(0,f.data),b=f.length,f.parentNode.removeChild(f),g&&this.setEnd(a,e+b),this.setStart(a,b)))},createNodeIterator:function(a,b){return new u(this,a,b)},getNodes:function(a,b){return t(this,a,b)}},_.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;return a&&(this._next=a!==this._last?a.nextSibling:null,c.isCharacterDataNode(a)&&this.clonePartiallySelectedTextNodes&&(a===this.ec&&(a=a.cloneNode(!0)).deleteData(this.eo,a.length-this.eo),this._current===this.sc&&(a=a.cloneNode(!0)).deleteData(0,this.so))),a},remove:function(){var a=this._current,b,d;!c.isCharacterDataNode(a)||a!==this.sc&&a!==this.ec?a.parentNode&&a.parentNode.removeChild(a):(b=a===this.sc?this.so:0,d=a===this.ec?this.eo:a.length,b!=d&&a.deleteData(b,d-b))},isPartiallySelectedSubtree:function(){var a=this._current;return w(a,this.range)},getSubtreeIterator:function(){var a;if(this.isSingleCharacterDataNode)a=this.range.cloneRange(),a.collapse();else{a=new S(g(this.range));var b=this._current,d=b,e=0,f=b,h=m(b);c.isAncestorOf(b,this.sc,!0)&&(d=this.sc,e=this.so),c.isAncestorOf(b,this.ec,!0)&&(f=this.ec,h=this.eo),j(a,d,e,f,h)}return new _(a,this.clonePartiallySelectedTextNodes)},detach:function(a){a&&this.range.detach(),this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}},S.fromRange=function(a){var b=new S(g(a));return j(b,a.startContainer,a.startOffset,a.endContainer,a.endOffset),b},S.copyComparisonConstants(S.prototype),S.rangeProperties=T,S.RangeIterator=_,S.DOMException=e,S.RangeException=R,S.util={getRangeDocument:g,inspectNode:f,rangesEqual:function(a,b){return a.startContainer===b.startContainer&&a.startOffset===b.startOffset&&a.endContainer===b.endContainer&&a.endOffset===b.endOffset}},rangy.DomRange=S}),rangy.createModule("WrappedRange",function(a,b){function g(a,b,c){this.position=a,this.cleanUpFunc=b,this.alteredDom=c}function h(a,b){var c=a.duplicate(),f=c.parentElement();c.collapse(b);var h=c.parentElement();d.isAncestorOf(f,h,!0)||(h=f);if(!h.canHaveHTML)return new g(new e(h.parentNode,d.getNodeIndex(h)),null,!1);var i=d.getDocument(h).createElement("span"),j,k=b?"StartToStart":"StartToEnd",l,m,n,o,p,q,r=null,s=!1;do h.insertBefore(i,i.previousSibling),c.moveToElementText(i);while((j=c.compareEndPoints(k,a))>0&&i.previousSibling);return o=i.nextSibling,j==-1&&o?(c.setEndPoint(b?"EndToStart":"EndToEnd",a),q=c.text,/[\r\n]/.test(o.data)&&(p=c.duplicate(),p.collapse(!1),p.text=" ",q=o.data.slice(0,-1),s=!0,r=function(){m=o.nextSibling,o.data=o.data.slice(0,-1)+m.data,m.parentNode.removeChild(m),a.collapse()}),n=new e(o,q.length)):(l=!b&&i.previousSibling,m=b&&i.nextSibling,m&&d.isCharacterDataNode(m)?n=new e(m,0):l&&d.isCharacterDataNode(l)?n=new e(l,l.length):n=new e(h,d.getNodeIndex(i))),i.parentNode.removeChild(i),new g(n,r,s)}function i(a,b){var c,e,f=a.offset,g=d.getDocument(a.node),h,i,j=g.body.createTextRange(),k=!1,l=!1,m=d.isCharacterDataNode(a.node);return m?(c=a.node,e=c.parentNode,e.nodeType==1&&(f==0&&!c.previousSibling?k=!0:f==c.length&&!c.nextSibling&&(l=!0))):(i=a.node.childNodes,a.node.nodeType==1&&(f==0?k=!0:f==i.length&&(l=!0)),c=f<i.length?i[f]:null,e=a.node),k||l?(j.moveToElementText(e),j.collapse(k)):(h=g.createElement("span"),c?e.insertBefore(h,c):e.appendChild(h),j.moveToElementText(h),e.removeChild(h),m&&j[b?"moveStart":"moveEnd"]("character",f)),j}a.requireModules(["DomRange"]);var c,d=a.dom,e=d.DomPosition,f=rangy.DomRange;g.prototype.cleanUp=function(){this.cleanUpFunc&&this.cleanUpFunc()};if(a.features.implementsDomRange)(function(){function e(a){var c=b.length,d;while(c--)d=b[c],a[d]=a.nativeRange[d]}var a,b=f.rangeProperties,d,g;c=function(a){if(!a)throw new Error("Range must be specified");this.nativeRange=a,e(this)},a=c.prototype={selectNode:function(a){this.nativeRange.selectNode(a),e(this)},selectNodeContents:function(a){this.nativeRange.selectNodeContents(a),e(this)},deleteContents:function(){this.nativeRange.deleteContents(),e(this)},extractContents:function(){var a=this.nativeRange.extractContents();return e(this),a},cloneContents:function(){return this.nativeRange.cloneContents()},insertNode:function(a){this.nativeRange.insertNode(a),e(this)},surroundContents:function(a){this.nativeRange.surroundContents(a),e(this)},collapse:function(a){this.nativeRange.collapse(a),e(this)},cloneRange:function(){return new c(this.nativeRange.cloneRange())},toString:function(){return this.nativeRange.toString()},detach:function(){this.nativeRange.detach(),this.detached=!0;var a=b.length,c;while(a--)c=b[a],this[c]=null}};var h=document.createTextNode("test");document.body.appendChild(h);var i=document.createRange();i.setStart(h,0),i.setEnd(h,0);try{i.setStart(h,1),d=!0,a.setStart=function(a,b){this.nativeRange.setStart(a,b),e(this)},a.setEnd=function(a,b){this.nativeRange.setEnd(a,b),e(this)},g=function(a,b){return function(b){this.nativeRange[a](b),e(this)}}}catch(j){d=!1,a.setStart=function(a,b){try{this.nativeRange.setStart(a,b)}catch(c){this.nativeRange.setEnd(a,b),this.nativeRange.setStart(a,b)}e(this)},a.setEnd=function(a,b){try{this.nativeRange.setEnd(a,b)}catch(c){this.nativeRange.setStart(a,b),this.nativeRange.setEnd(a,b)}e(this)},g=function(a,b){return function(c){try{this.nativeRange[a](c)}catch(d){this.nativeRange[b](c),this.nativeRange[a](c)}e(this)}}}a.setStartBefore=g("setStartBefore","setEndBefore"),a.setStartAfter=g("setStartAfter","setEndAfter"),a.setEndBefore=g("setEndBefore","setStartBefore"),a.setEndAfter=g("setEndAfter","setStartAfter"),i.selectNodeContents(h),i.setEnd(h,3);var k=document.createRange();k.selectNodeContents(h),k.setEnd(h,4),k.setStart(h,2),i.compareBoundaryPoints(i.START_TO_END,k)==-1&&i.compareBoundaryPoints(i.END_TO_START,k)==1?a.compareBoundaryPoints=function(a,b){return b=b.nativeRange||b,a==b.START_TO_END?a=b.END_TO_START:a==b.END_TO_START&&(a=b.START_TO_END),this.nativeRange.compareBoundaryPoints(a,b)}:a.compareBoundaryPoints=function(a,b){return this.nativeRange.compareBoundaryPoints(a,b.nativeRange||b)};var l=["compareNode","comparePoint","createContextualFragment","intersectsNode","isPointInRange","intersectsRange","splitBoundaries","normalizeBoundaries","createNodeIterator","getNodes"],m=l.length,n,o=f.prototype;while(m--)n=l[m],a[n]=o[n];document.body.removeChild(h),i.detach(),k.detach(),f.copyComparisonConstants(c),f.copyComparisonConstants(a)})();else if(a.features.implementsTextRange){c=function(a){var b,c;a.text?(c=h(a,!1),b=h(a,!0),b.cleanUp(),c.cleanUp(),this.alteredDom=b.alteredDom||c.alteredDom):(c=b=h(a,!0),b.cleanUp(),this.alteredDom=b.alteredDom),this.setStart(b.position.node,b.position.offset),this.setEnd(c.position.node,c.position.offset)},c.prototype=new f(document),c.rangeToTextRange=function(a){var b=i(new e(a.startContainer,a.startOffset),!0),c=i(new e(a.endContainer,a.endOffset),!1),f=d.getDocument(a.startContainer).body.createTextRange();return f.setEndPoint("StartToStart",b),f.setEndPoint("EndToEnd",c),f},f.copyComparisonConstants(c),f.copyComparisonConstants(c.prototype);var j=function(){return this}();typeof j.Range=="undefined"&&(j.Range=c)}a.WrappedRange=c,a.createNativeRange=function(a){if(rangy.features.implementsDomRange)return a.createRange();if(rangy.features.implementsTextRange)return a.body.createTextRange()},a.createRange=function(b){return new c(a.createNativeRange(b))},a.createRangyRange=function(a){return new f(a)}}),rangy.createModule("WrappedSelection",function(a,b){function m(a,b){a.anchorNode=b.startContainer,a.anchorOffset=b.startOffset,a.focusNode=b.endContainer,a.focusOffset=b.endOffset}function n(a){var b=a.nativeSelection;a.anchorNode=b.anchorNode,a.anchorOffset=b.anchorOffset,a.focusNode=b.focusNode,a.focusOffset=b.focusOffset}function o(a){a.anchorNode=a.focusNode=null,a.anchorOffset=a.focusOffset=0,a.rangeCount=0,a.isCollapsed=!0}function p(b){var c;return b instanceof f?(c=b._selectionNativeRange,c||(c=a.createNativeRange(d.getDocument(b.startContainer)),c.setEnd(b.endContainer,b.endOffset),c.setStart(b.startContainer,b.startOffset),b._selectionNativeRange=c,b.attachListener("detach",function(){this._selectionNativeRange=null}))):b instanceof g?c=b.nativeRange:window.Range&&b instanceof Range&&(c=b),c}function q(a){this.nativeSelection=a,this.refresh()}a.requireModules(["DomRange","WrappedRange"]);var c="boolean",d=a.dom,e=a.util,f=a.DomRange,g=a.WrappedRange,h,i;a.util.isHostMethod(window,"getSelection")?h=function(a){return(a||window).getSelection()}:a.util.isHostObject(document,"selection")?h=function(a){return(a||window).document.selection}:b.fail("No means of obtaining a selection object"),a.getNativeSelection=h;var j=h(),k=a.createNativeRange(document),l=e.areHostObjects(j,["anchorNode","focusNode"]&&e.areHostProperties(j,["anchorOffset","focusOffset"]));a.features.selectionHasAnchorAndFocus=l,typeof j.isCollapsed==c?i=function(a){return a.nativeSelection.isCollapsed}:l?i=function(a){return a.anchorNode===a.focusNode&&a.anchorOffset===a.focusOffset}:i=function(a){return a.rangeCount?a.getRangeAt(0).collapsed:!1},a.getSelection=function(a){return new q(h(a))};var r=q.prototype;if(l&&e.areHostMethods(j,["removeAllRanges","addRange"]))r.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),o(this)},r.addRange=function(a){this.nativeSelection.addRange(p(a)),n(this),this.isCollapsed=i(this),this.rangeCount=typeof this.nativeSelection.rangeCount=="number"?this.nativeSelection.rangeCount:1};else{if(!e.isHostMethod(j,"empty")||!e.isHostMethod(k,"select"))return b.fail("No means of selecting a Range or TextRange was found"),!1;r.removeAllRanges=function(){this.nativeSelection.empty(),this._range=null,o(this)},r.addRange=function(a){this._range=a,this.rangeCount=1,this.isCollapsed=this._range.collapsed,m(this,a),g.rangeToTextRange(a).select()}}if(e.isHostMethod(j,"getRangeAt")&&typeof j.rangeCount=="number")r.getRangeAt=function(a){return new g(this.nativeSelection.getRangeAt(a))},r.refresh=function(){n(this),this.isCollapsed=i(this),this.rangeCount=this.nativeSelection.rangeCount};else if(l&&typeof k.collapsed==c&&a.features.implementsDomRange)r.getRangeAt=function(a){if(a<0||a>=this.rangeCount)throw new DOMException("INDEX_SIZE_ERR");return this._range.cloneRange()},r.refresh=function(){var b,c,e=this.nativeSelection;e.anchorNode?(b=d.getDocument(e.anchorNode),c=a.createRange(b),c.setStart(e.anchorNode,e.anchorOffset),c.setEnd(e.focusNode,e.focusOffset),c.collapsed!==this.isCollapsed&&(c.setStart(e.focusNode,e.focusOffset),c.setEnd(e.anchorNode,e.anchorOffset)),n(this),this.isCollapsed=c.collapsed,this._range=c,this.rangeCount=1):(o(this),this._range=null)};else{if(!e.isHostMethod(j,"createRange")||!a.features.implementsTextRange)return b.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;r.getRangeAt=function(a){if(a<0||a>=this.rangeCount)throw new DOMException("INDEX_SIZE_ERR");return this._range},r.refresh=function(){var a;if(this.nativeSelection.type!="Control"){a=this.nativeSelection.createRange();if(a&&typeof a.text!="undefined"){this._range=new g(a),this._range.alteredDom&&g.rangeToTextRange(this._range).select(),m(this,this._range),this.rangeCount=1,this.isCollapsed=this._range.collapsed;return}}o(this),this._range=null}}e.isHostMethod(j,"removeRange")&&typeof j.rangeCount=="number"?r.removeRange=function(a){this.nativeSelection.removeRange(p(a)),n(this),this.rangeCount=this.nativeSelection.rangeCount,this.isCollapsed=i(this)}:r.removeRange=function(a){var b=this.getAllRanges(),c=!1;this.removeAllRanges();for(var d=0,e=b.length;d<e;++d)c||!f.rangesEqual(b[d],a)?this.addRange(b[d]):c=!0;this.rangeCount||o(this)},l&&a.features.implementsDomRange?r.isBackwards=function(){var a=this.nativeSelection,b=!1;return a.anchorNode&&(b=d.comparePoints(a.anchorNode,a.anchorOffset,a.focusNode,a.focusOffset)==1),b}:r.isBackwards=function(){return!1},e.isHostMethod(j,"toString")?r.toString=function(){return""+this.nativeSelection}:r.toString=function(){var a=[];for(var b=0,c=this.rangeCount;b<c;++b)a[b]=""+this.getRangeAt(b);return a.join("")},e.isHostMethod(j,"collapse")?r.collapse=function(a,b){this.nativeSelection.collapse(a,b),n(this),this.rangeCount=1,this.isCollapsed=!0}:r.collapse=function(b,c){if(this.anchorNode&&d.getDocument(this.anchorNode)!==d.getDocument(b))throw new DOMException("WRONG_DOCUMENT_ERR");var e=a.createRange(d.getDocument(b));e.setStart(b,c),e.collapse(!0),this.removeAllRanges(),this.addRange(e),this.isCollapsed=!0},e.isHostMethod(j,"collapseToStart")?r.collapseToStart=function(){this.nativeSelection.collapseToStart(),n(this),this.rangeCount=1,this.isCollapsed=!0}:r.collapseToStart=function(){if(!this.rangeCount)throw new DOMException("INVALID_STATE_ERR");var a=this.getRangeAt(0);a.collapse(!0),this.removeAllRanges(),this.addRange(a),this.isCollapsed=!0},e.isHostMethod(j,"collapseToEnd")?r.collapseToEnd=function(){this.nativeSelection.collapseToEnd(),n(this),this.rangeCount=1,this.isCollapsed=!0}:r.collapseToEnd=function(){if(!this.rangeCount)throw new DOMException("INVALID_STATE_ERR");var a=this.getRangeAt(this.rangeCount-1);a.collapse(!1),this.removeAllRanges(),this.addRange(a),this.isCollapsed=!0},e.isHostMethod(j,"selectAllChildren")?r.selectAllChildren=function(a){this.nativeSelection.selectAllChildren(a),n(this),this.rangeCount=1}:r.selectAllChildren=function(b){if(this.anchorNode&&d.getDocument(this.anchorNode)!==d.getDocument(b))throw new DOMException("WRONG_DOCUMENT_ERR");var c=a.createRange(d.getDocument(b));c.selectNodeContents(b),d.isCharacterDataNode(b)&&c.collapse(!0),this.removeAllRanges(),this.addRange(c)},e.isHostMethod(j,"deleteFromDocument")?r.deleteFromDocument=function(){this.nativeSelection.deleteFromDocument(),n(this),this.rangeCount=1}:r.deleteFromDocument=function(){if(this.rangeCount){var a=this.getAllRanges();this.removeAllRanges();for(var b=0,c=a.length;b<c;++b)a[b].deleteContents();this.addRange(a[c-1])}},r.getAllRanges=function(){var a=[];for(var b=0;b<this.rangeCount;++b)a[b]=this.getRangeAt(b);return a},r.setRanges=function(a){this.removeAllRanges();for(var b=0,c=a.length;b<c;++b)this.addRange(a[b])}}),rangy.createModule("WrappedSelection",function(a,b){function e(a,b){var e="selectionBoundary_"+(new Date).getTime()+"_"+Math.random().toString().substr(2),f,g=c.getDocument(a.startContainer),h=a.cloneRange();return h.collapse(b),f=g.createElement("span"),f.id=e,f.appendChild(g.createTextNode(d)),h.insertNode(f),h.detach(),f}function f(a,b,c,d){var e=a.getElementById(c);b[d?"setStartBefore":"setEndBefore"](e),e.parentNode.removeChild(e)}function g(b){b=b||window;var c=a.getSelection(b),d=c.getAllRanges(),f=[],g,h;for(var i=0,j=d.length;i<j;++i)h=e(d[i],!1),g=e(d[i],!0),d[i].setEndBefore(h),d[i].setStartAfter(g),f.push({startMarkerId:g.id,endMarkerId:h.id});return c.setRanges(d),{win:b,doc:b.document,rangeInfos:f,restored:!1}}function h(b){if(!b.restored){var c=b.rangeInfos,d=a.getSelection(b.win);d.removeAllRanges();for(var e=0,g=c.length,h,i;e<g;++e)h=c[e],i=a.createRange(b.doc),f(b.doc,i,h.startMarkerId,!0),f(b.doc,i,h.endMarkerId,!1),i.normalizeBoundaries(),d.addRange(i);b.restored=!0}}function i(a,b){var c=a.getElementById(b);c.parentNode.removeChild(c)}function j(a){var b=a.rangeInfos;for(var c=0,d=b.length,e;c<d;++c)e=b[c],i(a.doc,e.startMarkerId),i(a.doc,e.endMarkerId)}a.requireModules(["DomRange","WrappedRange"]);var c=a.dom,d="﻿";a.saveRestore={saveSelection:g,restoreSelection:h,removeMarkerElement:i,removeMarkers:j}});