var Sync=function(){function g(g){return console.log("getSyncId"),chrome.bookmarks.getTree(function(h){chrome.bookmarks.search(a,function(i){i.length===0?(f=!0,chrome.bookmarks.create({parentId:h[c].children[d].id,title:a,url:b},function(a){e=a,Sync.save(),f=!1,g()})):(e=i[0],g())})}),this}function h(a,b){console.log("bookmarkChanged"),e.id===a&&Sync.load()}function i(a,b){}function j(){chrome.bookmarks.getTree(function(b){chrome.bookmarks.search(a,function(a){var b=0;$.each(a,function(a,c){c.dateAdded>b&&(b=c.dateAdded,e=c)}),$.each(a,function(a,c){c.dateAdded!==b&&chrome.bookmarks.remove(c.id)}),console.log("bookmarkImported"),Sync.load()})})}function k(a,b){}var a="Smart Word Data",b="http://smartword/?data=",c=0,d=1,e,f=!1;return{id:function(){return e.id},initialize:function(){return console.log("initialize"),g(function(){Sync.listen(),console.log("Settings.lastSync():"+Settings.lastSync()),console.log("syncNode.dateAdded:"+e.dateAdded),Settings.lastSync()<e.dateAdded&&(console.log("Settings.lastSync() < syncNode.dateAdded"),Sync.load())}),this},listen:function(a){return a===undefined||a?(chrome.bookmarks.onChanged.addListener(h),chrome.bookmarks.onCreated.addListener(i),chrome.bookmarks.onImportEnded.addListener(j),chrome.bookmarks.onRemoved.addListener(k)):(chrome.bookmarks.onChanged.removeListener(h),chrome.bookmarks.onCreated.removeListener(i),chrome.bookmarks.onImportEnded.removeListener(j),chrome.bookmarks.onRemoved.removeListener(k)),this},load:function(){console.log("sync load"),console.log("syc load:syncing"+f);if(Settings.sync()&&!f)try{g(function(){console.log("syc load:getSyncId callback:overrite localstorage!");var a=JSON.parse(unescape(e.url.replace(b,"")));$.each(a,function(a,b){localStorage[a]=a==="sync"?"true":b}),refreshIcon()})}catch(a){}return this},overwrite:function(){var a=JSON.parse(unescape(e.url.replace(b,"")));alert(JSON.parse(a.lastSync)+", "+Settings.lastSync()+", "+(JSON.parse(a.lastSync)>Settings.lastSync));if(JSON.parse(a.lastSync)>Settings.lastSync()){for(var c in a)localStorage[c]=a[c];alert("reload time");var d=new Date;Settings.lastSync(d.getTime()),window.location.reload()}},save:function(){console.log("sync save");var a=new Date;return f=!0,Settings.lastSync(a.getTime()),chrome.bookmarks.update(e.id,{url:b+escape(JSON.stringify(localStorage))},function(a){f=!1}),this}}}();Sync.initialize();