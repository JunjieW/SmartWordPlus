"use strict",Array.prototype.shuffle=function(){for(var a,b,c=this.length;c;a=parseInt(Math.random()*c),b=this[--c],this[c]=this[a],this[a]=b);return this},window.setImmediate||(window.setImmediate=function(){return window.msSetImmediate||window.webkitSetImmediate||window.mozSetImmediate||window.oSetImmediate||function(){if(window.postMessage&&window.addEventListener){var a=[],b=-1,c=-1,d="zero-timeout-message",e=function(b){return a.push(b),window.postMessage(d,"*"),++c},f=function(c){if(c.data==d){c.stopPropagation();if(a.length>0){var e=a.shift();e(),b++}}};return window.addEventListener("message",f,!0),window.clearImmediate=function(d){if(typeof d!="number"||d>c)return;var e=d-b-1;a[e]=function(){}},e}}()||function(a){window.setTimeout(a,0)}}()),window.clearImmediate||(window.clearImmediate=function(){return window.msClearImmediate||window.webkitClearImmediate||window.mozClearImmediate||window.oClearImmediate||function(a){window.clearTimeout(a)}}()),function(a){a.wordCloudSupported=function(){var b=a("<canvas />"),c;return!b[0]||!b[0].getContext?!1:(c=b[0].getContext("2d"),c.getImageData?c.fillText?Array.prototype.some?Array.prototype.push?!0:!1:!1:!1:!1)}(),a.miniumFontSize=function(){if(!a.wordCloudSupported)return;var b=document.createElement("canvas").getContext("2d"),c=20,d,e;while(c){b.font=c.toString(10)+"px sans-serif";if(b.measureText("Ｗ").width===d&&b.measureText("m").width===e)return c+1;d=b.measureText("Ｗ").width,e=b.measureText("m").width,c--}return 0}(),a.fn.wordCloud=function(b){if(!a.wordCloudSupported)return this;var c={fontFamily:'"Trebuchet MS", "Heiti TC", "微軟正黑體", "Arial Unicode MS", "Droid Fallback Sans", sans-serif',gridSize:8,ellipticity:.65,center:!1,drawMask:!1,maskColor:"rgba(255,0,0,0.3)",maskGridWidth:.3,wordColor:"random-dark",backgroundColor:"#fff",wait:0,abortThreshold:0,abort:a.noop,weightFactor:1,minSize:a.miniumFontSize/2,wordList:[],rotateRatio:.1,clearCanvas:!0,fillBox:!1};b&&a.extend(c,b);if(typeof c.weightFactor!="function"){var d=c.weightFactor;c.weightFactor=function(a){return a*d}}c.gridSize=Math.max(c.gridSize,4);var e=c.gridSize,f,g,h,i,j,k,l,m=function(a,b,d,e,f){switch(c.wordColor){case"random-dark":return"rgb("+Math.floor(Math.random()*128).toString(10)+","+Math.floor(Math.random()*128).toString(10)+","+Math.floor(Math.random()*128).toString(10)+")";case"random-light":return"rgb("+Math.floor(Math.random()*128+128).toString(10)+","+Math.floor(Math.random()*128+128).toString(10)+","+Math.floor(Math.random()*128+128).toString(10)+")";default:return typeof c.wordColor!="function"?c.wordColor:c.wordColor(a,b,d,e,f)}},n=function(){return c.abortThreshold>0&&(new Date).getTime()-l>c.abortThreshold},o=function(a,b,c,d,e,f){return a[(c*d+b)*4+f]},p=function(a,b,c,d,f){var g=e,h;if(!isNaN(j))while(g--){h=e;while(h--)if(o(a.data,b+g,c+h,d,f,j)!==k[j])return!1}else{var i;while(g--){h=e;while(h--){i=4;while(i--)if(a.data[((c+h)*d+b+g)*4+i]!==k[i])return!1}}}return!0},q=function(a,b,d,h){var i=d,j;c.drawMask&&(f.fillStyle=c.maskColor);while(i--){j=h;while(j--)g[a+i][b+j]=!1,c.drawMask&&f.fillRect((a+i)*e,(b+j)*e,e-c.maskGridWidth,e-c.maskGridWidth)}},r=function(a,b,d,h){var i=d,j;c.drawMask&&(f.fillStyle=c.maskColor);var k=f.getImageData(a*e,b*e,d*e,h*e);a:while(i--){j=h;while(j--){p(k,i*e,j*e,d*e,h*e)||(g[a+i][b+j]=!1,c.drawMask&&f.fillRect((a+i)*e,(b+j)*e,e-c.maskGridWidth,e-c.maskGridWidth));if(n())break a}}},s=function(b,d){var g,j,k=1,l=Math.random()<c.rotateRatio,n=c.weightFactor(d);if(n<=c.minSize)return!1;n<a.miniumFontSize&&(k=function(){var b=2;while(b*n<a.miniumFontSize)b+=2;return b}()),f.font=(n*k).toString(10)+"px "+c.fontFamily;if(l){var o=f.measureText(b).width/k,p=Math.max(n*k,f.measureText("m").width,f.measureText("Ｗ").width)/k;/[Jgpqy]/.test(b)&&(p*=1.5),p+=Math.floor(n/6),o+=Math.floor(n/6)}else{var p=f.measureText(b).width/k,o=Math.max(n*k,f.measureText("m").width,f.measureText("Ｗ").width)/k;/[Jgpqy]/.test(b)&&(o*=1.5),o+=Math.floor(n/6),p+=Math.floor(n/6)}p=Math.ceil(p),o=Math.ceil(o),g=Math.ceil(p/e),j=Math.ceil(o/e);var s=c.center?[c.center[0]/e,c.center[1]/e]:[h/2,i/2],u=Math.floor(Math.sqrt(h*h+i*i)),v=h+i,w,x,y,z,A;w=u+1;while(w--){x=v,y=[];while(x--)y.push([Math.floor(s[0]+(u-w)*Math.cos(-x/v*2*Math.PI)-g/2),Math.floor(s[1]+(u-w)*c.ellipticity*Math.sin(-x/v*2*Math.PI)-j/2),x/v*2*Math.PI]);if(y.shuffle().some(function(a){if(t(a[0],a[1],g,j)){if(k!==1||l){var h=document.createElement("canvas");h.setAttribute("width",p*k),h.setAttribute("height",o*k);var i=h.getContext("2d");i.fillStyle=c.backgroundColor,i.fillRect(0,0,p*k,o*k),i.fillStyle=m(b,d,n,u-w,a[2]),i.font=(n*k).toString(10)+"px "+c.fontFamily,i.textBaseline="top",l&&(i.translate(0,o*k),i.rotate(-Math.PI/2)),i.fillText(b,Math.floor(n*k/6),0),f.clearRect(Math.floor(a[0]*e+(g*e-p)/2),Math.floor(a[1]*e+(j*e-o)/2),p,o),f.drawImage(h,Math.floor(a[0]*e+(g*e-p)/2),Math.floor(a[1]*e+(j*e-o)/2),p,o)}else f.font=n.toString(10)+"px "+c.fontFamily,f.fillStyle=m(b,d,n,u-w,a[2]),f.fillText(b,a[0]*e+(g*e-p)/2,a[1]*e+(j*e-o)/2);return c.fillBox?q(a[0],a[1],g,j):r(a[0],a[1],g,j),!0}return!1}))return!0}return!1},t=function(a,b,c,d){if(a<0||b<0||a+c>h||b+d>i)return!1;var e=c,f;while(e--){f=d;while(f--)if(!g[a+e][b+f])return!1}return!0};return this.each(function(){if(this.nodeName.toLowerCase()!=="canvas")return;var b=a(this);h=Math.floor(b.attr("width")/e),i=Math.floor(b.attr("height")/e),f=this.getContext("2d"),g=[];var d=document.createElement("canvas").getContext("2d");d.fillStyle=c.backgroundColor,d.clearRect(0,0,1,1),d.fillStyle=c.backgroundColor,d.fillRect(0,0,1,1),k=d.getImageData(0,0,1,1).data;if(typeof c.wordColor!="function"&&c.wordColor.substr(0,6)!=="random"){d.fillStyle=c.wordColor,d.fillRect(0,0,1,1);var m=d.getImageData(0,0,1,1).data,o=4;while(o--)if(Math.abs(m[o]-k[o])>10){j=o;break}}else j=NaN;var p=h,q;while(p--){g[p]=[],q=i;while(q--)g[p][q]=!0}c.clearCanvas?(f.fillStyle=c.backgroundColor,f.clearRect(0,0,h*(e+1),i*(e+1)),f.fillRect(0,0,h*(e+1),i*(e+1))):r(0,0,h,i),f.textBaseline="top",b.trigger("wordcloudstart");var o=0;if(c.wait!==0){var t=setInterval(function(){if(o>=c.wordList.length){clearTimeout(t),b.trigger("wordcloudstop");return}l=(new Date).getTime(),s(c.wordList[o][0],c.wordList[o][1]),n()&&(clearTimeout(t),c.abort(),b.trigger("wordcloudabort"),b.trigger("wordcloudstop")),o++},c.wait);b.one("wordcloudstart",function(a){clearTimeout(t)})}else{var u=!1;window.setImmediate(function v(){if(o>=c.wordList.length){b.trigger("wordcloudstop");return}if(u)return;l=(new Date).getTime(),s(c.wordList[o][0],c.wordList[o][1]);if(n()){c.abort(),b.trigger("wordcloudabort"),b.trigger("wordcloudstop");return}o++,window.setImmediate(v)}),b.one("wordcloudstart",function(){u=!0})}})}}(jQuery);